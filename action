#!/usr/bin/env php
<?php

if(file_exists(__DIR__.'/vendor/autoload.php')) {
    require __DIR__.'/vendor/autoload.php';
} else {
    require __DIR__.'/../../autoload.php';
}

$packageName = getenv('packageName') ?: $argv[1];
$packagistApiToken = getenv('PACKAGIST_API_TOKEN') ?: $argv[2];
$packagistApiSecret = getenv('PACKAGIST_API_SECRET') ?: $argv[3];

use PrivatePackagist\ApiClient\Client;

$client = new Client();
$client->authenticate($packagistApiToken, $packagistApiSecret);
$packages = $client->packages()->listDependents($packageName);
$urls = [];
foreach ($packages as $package) {
    $urls[] = ltrim(parse_url($package['config']['url'], PHP_URL_PATH), '/');
}
echo '::set-output name=packages::' . json_encode($urls);
